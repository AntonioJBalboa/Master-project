---
title: "k_optimization"
author: "Antonio Jes√∫s Balboa Ortega"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# load libraries
require(tidyverse)
require(vegan)
require(dplyr)
require(purrr)
require(ggupset)
require(tibble)
require(Biostrings)
# Seed
set.seed(26)
```


```{r ground truth, include=FALSE}
# load modified species taxonomy for species
taxonomy_mod_100 <- read.csv("taxonomia_mod_100.csv")

# Create OTU table
OTU_table <- seqtab.nochim

sequences <- colnames(OTU_table)

asv_ids <- paste0("ASV", seq_along(sequences))

# Dictionary for storing sequences and taxa
seq_dict <- data.frame(
  ASV = asv_ids,
  Sequence =  sequences,
  taxa = taxonomy_mod_100$Genus_Species,
  stringsAsFactors = FALSE)

colnames(OTU_table) <- asv_ids

# Defining ground truth

ground_truth_sequences <- data.frame(
  Bacteria = c("Bacillus licheniformis BT_1B_CT2","Bifidobacterium longum 12_1_47 B FAA","Rothia mucilaginosa CC87LB","Parvimonas micra CD1 D6 FAA 3","Mogibacterium timidum CD1 D5 FAA 3","Campylobacter concisus 10_1_50","Eggerthella lenta MR1 12","Slackia exigua CD1 D6 FAA 13","klebsiella variicola 1_1_55","Fusobacterium periodonticum D10","Leptotrichia goodfellowii D28","Weisella cibaria F16 1","Eikenella corrodens CC82I","Neisseria pneumonie GT 4A CT1","Tannerella sp. 6_1_58 FAA CT1","Hoylesella oralis CC98A","Capnocytophaga sputigena CC21 001D","Granulicatella adiacens CC94D","Streptococcus gordonii 2_1_36 FAA","Gemella morbillorum CC57F","Dialister invisus DSM 15470","Veionella sp. 3_1_44","Coprobacillus cateniformis 29_1","Bifidobacterium angulatum F16 22","Collinsella aerofaciens 4_8_47 FAA","Bilophila wadsworthia AC2_8_11_AN_D5_FAA_1","Escherichia coli 1_1_43","Fusobacterium gonidiaformans 3_1_5R","Fusobacterium ulcerans 12_1B","Anaerostipes hadrus 5_1_63_FAA","Lactobacillus iners 7_1_47 FAA","Pediococcus acidilactici 7_4A","Ralstonia pickettii 5_7_47 FAA","Paenibacillus barengoltzii CC33 002B ","Parabacteroides merdae UC1 BHI R","Bacteroides caccae MR1 13","Propionibacterium acnes 5_U_42 FAA","Alistipes shahii ETR2 14","Enterococcus saccharolyticus 30_1","Synergistes sp. 22_5_S_12_D6 FAA"),
  Sequence = c("TCCTGTTCGCTCCCCACGCTTTCGCGCCTCAGCGTCAGTTACAGACCAGAGAGTCGCCTTCGCCACTGGTGTTCCTCCACATCTCTACGCATTTCACCGCTACACGTGGAATTCCACTCTCCTCTTCTGCACTCAAGTTCCCCAGTTTCCAATGACCCTCCCCGGTTGAGCCGGGGGCTTTCACATCAGACTTAAGAAACCGCCTGCGCGCGCTTTACGCCCAATAATTCCGGACAACGCTTGCCACC",
               "TACGTAGGGTGCAAGCGTTATCCGGAATTATTGGGCGTAAAGGGCTCGTAGGCGGTTCGTCGCGTCCGGTGTGAAAGTCCATCGCTTAACGGTGGATCCGCGCCGGGTACGGGCGGGCTTGAGTGCGGTAGGGGAGACTGGAATTCCCGGTGTAACGGTGGAATGTGTAGATATCGGGAAGAACACCAATGGCGAAGGCAGGTCTCTGGGCCGTTACTGACGCTGAGGAGCGAAAGCGTGGGGAGCGAAC",
               "TACGTAGGGCGCGAGCGTTGTCGTGAAGGGCCGGGGTTAAGCCCCGGCCTTTCACAGCAGACGCGACAAACCGCCTACAAGCTCTTTACGCCCAATAATTCCGGACAACGCTCGCGCCCTACGCAAGGCTGGTGGCCCCAGCTACCTGATCGCTCTGTCCGATTGGGAGCCGGCACAGGCAACCGCAACCGCTGTCACCCAGTCCGTGACCGTCCGCGAGACCCTGGGACTCATTTACCCACTGACGAAC",
               "TACGTATGGGGCGAGCGTTGTCCGGAATGGCGGAATGCTTAATGTGTTAACTTCGGCACCGAGATTTGACTCCCAACACCTAGCATTCATCGTTTACGGCGTGGACTACCAGGGTATCTAATCCTGTTTTTCAGGAAATGTAACTTTGTATTCAACATATGCTATCTTATATTTCCCATCTTTTCCATGTGGATAATAACCAGAATCTGCAGCTTGTTTCATTTCACTTTTGATAAGAATGGAAAGAATA",
               "TACGTAGGGGGCAAGCGTTATCCTTAATTATTGGGCGTAAAGAGTGCGTAGGTGGTTACCTAAGCGTCTACGCATTTCACCGCTACACTAGGAATTCCGCTTTCCCCTCCTGCACTCAAGTAGCCCAGTTCGCAAGGCATGTAAAGGTTGAGCCTCTAATTTAAACCTGCGATGTCAGTAACCTGTGCGCCTCTAGCACGCATAGTCGTAAACGCTTCGTGTCCCTTAGTATCGAGGAATACAATTTTCT",
               "TACGGAGGGTGCAAGCGTTACTCGGAATCACTGGGCGTAAAGGACGCGTAGGCGGATTATCAAGTCTCTTGTGAAATCCTATGGCTTAACCATAGAACTGCTTGGGAAACTGATAATCTAGAGTGAGGGAGAGGCAGATGGAATTGGTGGTGTAGGGGTAAAATCCGTAGAGATCACCAGGAATACCCATTGCGAAGGCGATCTGCTGGAACTCAACTGACGCTAATGCGTGAAAGCGTGGGGAGCAAAC",
               "CGTAGGGAGCGAGCGTTATCCGGATTCATTGGGCGTAAAGAGCGCGTAGGCGGCCTCTCAAGCGGGATCTCTAATCCGAGGGCTCAACCCCCGGCCGGATCCCGAACTGGGAGGCTCGAGTTCGGTAGAGGCAGGCGGAATTCCCGGTGTAGCGGTGGAATGCGCAGATATCGGGAAGAACACCGATGGCGAAGGCAGCCTGCTGGGCCGCAACTGACGCTGAGGCGCGAAAGCTAGGGGAGCGAACAGG",
               "TACGTAGGGGGCGAGCGTTATGGTCGCTTCCGGGGGTTGAGCCCCCGGCTTCGACGAGGCCGCTTGGCGGGCCGCCTGCGCGCGCTTTACGCCCAATGAATCCGGATAACGCTCGCCCCCTAAACGCGCTGGCAAGGGGACCGGCCGGTCCGGACGAGCCCCTCGACGCCTGGAACGCCTCCGATGATGAGGCACCCTGCGCCGCATCCGCCGCGCCGAGAAGCCTTCGCTTCCCCGAAAGGCCCGCTTT",
               "TACGGAGGGTGCAAGCGTTAATCGGAATTACTGGGCGTAAAGCGCACGCAGGCGGTCTGTCAAGTCGGATGTGAAATCCCCGGGCTCAACCTGGGAACTGCATTCGAAACTGGCAGGCTAGAGTCTTGTAGAGGGGGGTAGAATTCCAGGTGTAGCGGTGAAATGCGTAGAGATCTGGAGGAATACCGGTGGCGAAGGCGGCCCCCTGGACAAAGACTGACGCTCAGGTGCGAAAGCGTGGGGAGCAAAC",
               "CGTATGTCACAAGCGTTATCCGGATTTATTGGGCGTAAAGCGCGTCTAGGTGGTTATGTAAGTCTGATGTGAAAATGCAGGGCTCAACTCTGTATTGCGTTGGAAACTGCATGACTAGAGTACTGGAGAGGTAAGCGGAACTACAAGTGTAGAGGTGAAATTCGTAGATATTTGTAGGAATGCCGATGGGGAAGCCAGCTTACTGGACAGATACTGACGCTAAAGCGCGAAAGCGTGGGTAGCAAACAGG",
               "TACGTATGTCGCGAGCGTTATCCGGAATTATTGGGCATAAAGGGCATCTAGGCGGACGATCAAGTCAGGGGTGAAAACTTGCGGCTCAACTGTAAGCTTGCCTTTGAAACTGATTGTCTAGAGTATTGGAAAGGTGGGCGGAACTACACGAGTAGAGGTGAAATTCGTAGATATGTGTAGGAATGCCGATGATGAAGATAGCTCACTGGACGATAACTGACGCTGAAGTGCGAAAGCTAGGGGAGCGAAC",
               "TACGTATGTTCCAAGCGTTATCCGGATTTATGCCTTCTCACGGATGCGTTACGATGATCCACAGGGAGACTACGGTCGTCAGGAACGTCAGCGATTGGTGCTGCAAGGAATTGTTGACGCAGCGAAGAGCAACCTATTAAAAGAGCTTTTACTACCTTATTCATCACATTAACTCCCAAATTCAATCTTGTTACATATTTCACTTTTTATAATGCGCTATCTTGCGGTTAAAACCAACCATCATCTTCTG",
               "TACGTAGGGTGCGAGCGTTAATCGGAATTACTGGGCGTAAAGCGAGCGCAGACGGTTATTTAAGCAGGATGTGAAATCCCCGGGCTTAACCTGGGAACTGCGTTCTGAACTGGATAGCTAGAGTGTGTCAGAGGGGGGTAGAATTCCACGTGTAGCAGTGAAATGCGTAGAGATGTGGAGGAATACCGATGGCGAAGGCAGCCCCCTGGGATAACACTGACGTTCATGCTCGAAAGCGTGGGTAGCAAAC",
               "TACGTAGGGTGCGAGCGTTAATCGGAATTACTGGGCGTAAAGCGGGCGCAGACGGTTACTTAAGCAGGATGTGAAATCCCCGGGCTCAACCTGGGAACTGCGTTCTGAACTGGGTGACTAGAGTGTGTCAGAGGGAGGTAGAATTCCACGTGTAGCAGTGAAATGCGTAGAGATGTGGAGGAATACCGATGGCGAAGGCAGCCTCCTGGGATAACACTGACGTTCATGCCCGAAAGCGTGGGTAGCAAAC",
               "GTAATACGGAAGATGCGAGCGGATTTATTGGGTTTAAAGGGTGCGTAGGCGGAAGGATAAGTCAGCGGTGAAATGCATTCAGCTCAACTGGAGAATTGCCGATGAAACTGTTTTTCTAGAGTATAAAAGAGGTATGCGGAATGCGTGGTGTAGCGGTGAAATGCATAGATATCACGCAGAACCCCGATTGCGAAGGCAGCATACTGGGCTATAACTGACGCTGAAGCACGAAAGCGTGGGTATCGAACAGG",
               "TACGGAAGGTCCGGGCGTTATCCGGATTTATTGGGTTTAAAGGGAGCGTAGGCAGTTTTTTAAGCGTGCTGTGAAATGTACCGGCTCAACCGGTGATGTGCAGCGCGAACTGGGAATCTTGAGTACGCAGTAAGCAGGCGGAATTCGTGGTGTAGCGGTGAAATGCTTAGATATCACGAAGAACTCCGATTGCGTAGGCAGCTTGCTGTAGCGTAACTGACGCTGAAGCTCGAAAGTGCGGGTATCGAAC",
               "TACGGAGGATGCGAGCGTTATCCGGAATCATTGGGTTTAAAGGGTCCGTAGGCGGGCTGATAAGTCAGAGAATATCTAAGCATTTCACCGCTACACTACACATTCCAACTACTTCACAATCATTCAAGACTGACAGTTTCAAAGGCAGTTGCTTAGTTGAGCTAAGCGCTTAAAAGTTTCAAAAACATTGTCCTCAATACGTATATTAGAGTGAAAATATTTTTGTTGTGCCTCTAAATTAGGGATTTCG",
               "TACGTAGGAATGACCCTCCCCGGTTGAGCCGGGGGCTTTCACATCAGACTTAAGGAACCGCCTGCGCTCGCTTTACGCCCAATAAATCCGGACAACGCTTGCCACCTACTGGAATCATTACAGGAAGTTTTTCACCATTCACGGTTACTACAAAAGTTGTCATCGCTCCATTGCTCTCAATTTCAGTAGCTCGAATATCTGCTTCTTCAGGAGAAGCCACGGGTAGCTATCCTAAATCGTGACCAGGAAT",
               "TACGTAGGTCCCGAGCGTTGTCCGGATTTATTGGGCGTAAAGCGAGCGCAGGCGGTTAGATAAGTCTGAAGTTAAAGGCTGTGGCTTAACCATAGTACGCTTTGGAAACTGTTTAACTTGAGTGCAGAAGGGGAGAGTGGAATTCCATGTGTAGCGGTGAAATGCGTAGATATATGGAGGAACACCGGTGGCGAAAGCGGCTCTCTGGTCTGTAACTGACGCTGAGGCTCGAAAGCGTGGGGAGCGAACA",
               "TACGTAGGTGGCAAGCGTTGTCCGGAATTATTGGGCGATTAATTATAGCGTAAATACTTATTTAAGTTATACATAAGGAGGAATTTGATATGCCACGTGTTAAAGGTGGAACTGTGACTCGTCGTCGCCGTAAAAAAGTGCTTCTGCTTTTGTTTTAACTCCTAATTGTTCCCCATTTTGACTAATTAAAAGAAACTCTTTCGCTTTAATACCTTCATTTACTTGTGCAGTATCTTTAC",
               "CGTAGGTGGCAAGCGTTGTCCGGAATTATTGGGCGTAAAGCGCGCGCAGGCGGCTTCCCAAGTCCCTCTTAAAAGTGCGGGGCTTAACCCCGTGATGGGAAGGAAACTGGGAAGCTGGAGTATCGGAGAGGAAAGTGGAATTCCTAGTGTAGCGGTGAAATGCGTAGAGATTAGGAAGAACACCGGTGGCGAAGGCGACTTTCTGGACGAAAACTGACGCTGAGGCGCGAAAGCGTGGGGAGCAAACAGG",
               "TACGTAGGTGGCAAGCGTTGTCCGGAATTATTGGGCGTAAAGCGCGCGCAGGCGGATAGGTCAGTCTGTCTTAAAAGTTCGGGGCTTAACCCCGTGATGGGATGGAAACTGCCAATCTAGAGTATCGGAGAGGAAAGTGGAATTCCTAGTGTAGCGGTGAAATGCGTAGATATTAGGAAGAACACCAGTGGCGAAGGCGACTTTCTGGACGAAAACTGACGCTGAGGCGCGAAAGCCAGGGGAGCGAACG",
               "TACGTAGGTGGCGAGCGTTATCCGGAATCATTGGGCGTAAAGAGGGAGCAGGCGGCAATAGAGGTCTGCGGTGAAAGCCTGAAGCTAAACTTCAGTAAGCCGTGGAAACCAAATAGCTAGAGTGCAGTAGAGGATCGTGGAATTCCATGTGTAGCGGTGAAATGCGTAGATATATGGAGGAACACCAGTGGCGAAGGCGACGATCTGGGCTGCAACTGACGCTCAGTCCCGAAAGCGTGGGGAGCAAATA",
               "TACGTAGGGTGCAAGCGTTATCCGGAATTAATCCGCAAAGGGCATCGTGTGCTGGAATCCGGCGCGGGGTCCGGAGCCATGAGCGTGAATCTGCTGGACGCCGTCGGCGAGACCGGATCGCTGACCACCATCGCAGATAACGCAGATACATGGTGGCATTGCGGTACAGGATCTGCAGAATGAACCGCGAGCGCATGAAGGTGTTGAATCCGCGGATCGTGCCTTCCATGAAATCGTTCCGGGTTCCGTA",
               "TACGTAGGGGGCGAGCGTTATCCGGATTCATTGGGCGTAAAGCGCGCGTAGGCGGCCCGGCAGGCCGGGGGTCGAAGCGGGGGGCTCAACCCCCCGAAGCCCCCGGAACCTCCGCGGCTTGGGTCCGGTAGGGGAGGGTGGAACACCCGGTGTAGCGGTGGAATGCGCAGATATCGGGTGGAACACCGGTGGCGAAGGCGGCCCTCTGGGCCGAGACCGACGCTGAGGCGCGAAAGCTGGGGGAGCGAAC",
               "TACGGAGGGTGCAAGCGTTAATCGGAATCACTGGGCGTAAAGCGCACGTAGGCGGCTTGGTAACAACAAAAAGCCTTCCCGAACCGTCGGGCTGCAAAGGAAGCCCTCCCCATTCCAATAGAGCCACAGGATCCAGCCGAGCGAAAAGGGTATCAAAACTATTTCACTTTTGCGCTGTACGGTTTTATCCGAAAAACGGTTTCCGTCGAAGCGCTTCCCGGCTTGTTCATTGAGACGGTAGTTTTGATAC",
               "GGAGGGTGCAAGCGTTAATCGGAATTACTGGGCGTAAAGCGCACGCAGGCGGTTTGTTAAGTCAGATGTGAAATCCCCGGGCTCAACCTGGGAACTGCATCTGATACTGGCAAGCTTGAGTCTCGTAGAGGGGGGTAGAATTCCAGGTGTAGCGGTGAAATGCGTAGAGATCTGGAGGAATACCGGTGGCGAAGGCGGCCCCCTGGACGAAGACTGACGCTCAGGTGCGAAAGCGTGGGGAGCAAACAGG",
               "CGTATGTCGCAAGCGTTATCCGGATTTATTGGGCGTAAAGCGCGTCTAGGCGGCAAGGAAAGTCTGATGTGAAAATGCGGGGCTCAACTCCGTATTGCGTTGGAAACTGCCTTACTAGAGTACTGGAGAGGTAGGCGGAACTACAAGTGTAGAGGTGAAATTCGTAGATATTTGTAGGAATGCCGATGGGGAAGCCAGCTACTGGACAGATACTGACGCTAAAGCGCGAAAGCGTGGGTAGCAAACAGG",
               "TACGTATGTCGCAAGCGTTATCCGGATTTATTGGGCGTAAAGCGCGTCTAGGCGGCAAGGAAAGTCTGATGTGAAAATGCGGGGCTCAACTCCGTATTGCGTTGGAAACTGCCTTACTAGAGTACTGGAGAGGTAGGCGGAACTACAAGTGTAGAGGTGAAATTCGTAGATATTTGTAGGAATGCCGATGGGGAAGCCAGCCTACTGGACAGATACTGACGCTAAAGCGCGAAAGCGTGGGTAGCAAACA",
               "ACCGAAGCCTCTACGGCCCCGACACCTAGTATTCATCGTTTACGGCGTGGACTACCAGGGTATCTAATCCTGTTTGCTCCCCACGCTTTCGTGCCTCAGTGTCAGTTTCAGTCCAGTAAGCCGCCTTCGCCACTGATGTTCCTCCTAATATCTACGCATTTCACCGCTACACTAGGAATTCCGCTTACCTCTCCTGCACTCCAGTCTGACAGTTTCAAAAGCAGTCCCAGAGTTAAGCCCTGGGTTTTCA",
               "ACGTAGGTGGCAAGCGTTGTCCGGATTTATTGGGCGTAAAGCGAGTGCAGGCGGCTCGATAAGTCTGATGTGAAAGCCTTCGGCTCAACCGGAGAATTGCATCAGAAACTGTCGAGCTTGAGTACAGAAGAGGAGAGTGGAACTCCATGTGTAGCGGTGAAATGCGTAGATATATGGAAGAACACCGGTGGCGAAGGCGGCTCTCTGGTCTGTTACTGACGCTGAGGCTCGAAAGCATGGGTAGCGAACA",
               "ACGTAGGTGGCAAGCGTTATCCGGATTTATTGGGCGTAAAGCGAGCGCAGGCGGTCTTTTAAGTCTAATGTGAAAGCCTTCGGCTCAACCGAAGAAGTGCATTGGAAACTGGGAGACTTGAGTGCAGAAGAGGACAGTGGAACTCCATGTGTAGCGGTGAAATGCGTAGATATATGGAAGAACACCAGTGGCGAAGGCGGCTGTCTGGTCTGTAACTGACGCTGAGGCTCGAAAGCATGGGTAGCGAACA",
               "TACGTAGGGTCCAAGCGTTAATCGGAATTACTGGGCGTAAAGCGTGCGCAGGCGGTTGTGCAAGACCGATGTGAAATCCCCGAGCTTAACTTGGGAATTGCATTGGTGACTGCACGGCTAGAGTGTGTCAGAGGGGGGTAGAATTCCACGTGTAGCAGTGAAATGCGTAGAGATGTGGAGGAATACCGATGGCGAAGGCAGCCCCCTGGGATAACACTGACGCTCATGCACGAAAGCGTGGGGAGCAAAC",
               "TACGTAGGGAGATCGGAAGAGCACACGTCTGAACTCCAGTCACCCCCTACGTATTACCGCGGCTGCTGGCACGTAGTTAGCCGGGGCTTTCTTCTCAGGTACCGTCACTCAGATCGGAAGAGCGTCGTGTAGGGAAAGAGGGTAGCGCTTTACGCCCAATAATTCCGGACAACGCTTGCCCCCTACGTATTACCGCGGCTGCTGGCACGTAGTTAGCCGGGGCTTTCTTCTCAGGTACCGTCACTCGAAA",
               "TACGGAGGATGCGAGCGTTATCCGGATTTATTGGGTTTCGGTTGTTCGCTGATCAGGAAGCTGGTACCTAAAACCGTCACCTCCGTCATGGCCGTATTAACGGAAAAGGGGCGCGCCTCGTTCCTCTTCACTTGGAAAATGCCGGATAGTACGCTGATTTCGATGGCCGGAAATTCGACACTCCGGTATGATGTGAAGAAATATGGAAAGGAAAGGCGCGTAGTGGAGATGACAGGGAAA",
               "TACGGAGGATCCGAGCGTTATCCGGATTTATTGGGTTTAAGTATCGGTATTTCTGAACAAGATAAAGATAAAATATTTGCACGATTCTTTCAGGCTGACAATCAAGAAAAGAAAGGAAGCCTGTTTAGCGGAACCGGTATCCGGCGGGGCAGCCGCACTGTAAATGTACTACCTTCACCAACAACACTTTTCACTGTTATCTCTCCATGATGTTTTTCCACAATTGTTCTGGTCAATGCCAA",
               "TACGTAGGGTGCGAGCGTTGTCCGGATTTATTGGGCGTAAAGGGCTCGTAGGTGGTTGATCGCGTCGGAAGTGTAATCTTGGGGCTTAACCCTGAGCGTGCTTTCGATACGGGTTGACTTGAGGAAGGTAGGGGAGAATGGAATTCCTGGTGGAGCGGTGGAATGCGCAGATATCAGGAGGAACACCAGTGGCGAAGGCGGTTCTCTGGGCCTTTCCTGACGCTGAGGAGCGAAAGC",
               "TACGGAGGATCCAAGCGTTATCCGGATTTATTGGGTTTAAACTACCGCAACTACTCTCTAGTTCAACAGTATTAGAGGCAGTTCCGGTGTTAAGCACCGGTATTTCACCTCTAACTTATCAAACCGCCTACGCACCCTTTAAGTGCGGGACTCTTTGGCCTGGTGCGAGGCAATGATGATCGAGTAAAGTTCCGACATCTGTACCGTGCGGAACTGCACGTTGGAGAAAAGCGCGTCCTCGGGTTATGAT",
               "ACGTAGGTGGCAAGCGTTGTCCGGATTTATTGGGCGTAAAGCGAGCGCAGGCGGTTTCTTAAGTCTGATGTGAAAGCCCCCGGCTCAACCGGGGAGGGTCATTGGAAACTGGGAGACTTGAGTGCAGAAGAGGAGAGTGGAATTCCATGTGTAGCGGTGAAATGCGTAGATATATGGAGGAACACCAGTGGCGAAGGCGGCTCTCTGGTCTGTAACTGACGCTGAGGCTCGAAAGCGTGGGGAGCGAACA",
               "TACGTAGGGAGCGAGCGTTATCCGGAATTACTGGGCGTGGGACTACCGGGGTATCTAATCCCGTTCGCTCCCCCGGCTTTCGCGCTTCAGCGTCAGATCACATCCAGCAAACCGCCTTCGCCACCGGTATTCTTCCTGAGTGTAGCCCTTGACGGGATTGCCCCGGGCGCCGCCGACTGAAACGCCGAGATTGTAGGTGTTTGCCAGGTATTCGGAGCCCTTGCGCGCGATCCATTCCAGGGCGCGCTTT"))


ground_truth_species <- c("Bacillus_licheniformis","Bifidobacterium_longum","Rothia_mucilaginosa","Parvimonas_micra","Mogibacterium_timidum","Campylobacter_concisus","Eggerthella_lenta","Slackia_exigua","klebsiella_variicola","Fusobacterium_periodonticum","Leptotrichia_goodfellowii","Weisella_cibaria","Eikenella_corrodens","Neisseria_mucosa","Tannerella_sp","Prevotella_oralis","Capnocytophaga_sputigena","Granulicatella_adiacens","Streptococcus_gordonii","Gemella_morbillorum","Dialister_invisus","Veionella_parvula","Coprobacillus_cateniformis","Bifidobacterium_angulatum","Collinsella_aerofaciens","Bilophila_wadsworthia","Escherichia_coli","Fusobacterium_gonidiaformans","Fusobacterium_varium","Fusobacterium_ulcerans","Anaerostipes_hadrus","Clostridium_bolteae","Lactobacillus_iners","Pediococcus_acidilactici","Ralstonia_pickettii","Paenibacillus_barengoltzii","Parabacteroides_merdae","Bacteroides_caccae","Propionibacterium_acnes","Alistipes_shahii","Subdoligranulum_variabile","Enterococcus_saccharolyticus","Synergistes_sp.")

OTU_table_df <- data.frame(OTU_table)
```

```{r}
set.seed(26)

# Validation of the algorithm for taxonomy and sequences and obtaining metrics
# Add-one procedure. The reintroduction of each ASV is evaluated after conservative filtering
k_especies <- k_validation(
  OTU_table = OTU_table_df,
  ground_truth = ground_truth_species,
  alpha = 0.5,
  beta = 0.5,
  mode ="taxonomy"
)

k_secuencias <- k_validation(
  OTU_table = OTU_table_df,
  ground_truth = ground_truth_sequences,
  alpha = 0.5,
  beta = 0.5,
  mode ="sequence")

# Results
k_especies_df <- k_especies$df_results
k_secuencias_df <- k_secuencias$df_results


```

```{r plots}
# Variation of k for each reintroduced ASV
plot_k(k_secuencias)

#Variation of Evenness, Bray Curtis and k for each reintroduced ASV
plot_J_BC_k(k_secuencias)
```


```{r bootstrap for alpha and beta 0.5}
val_boot_05_05 <- lapply(k_secuencias$asvs_recuperadas, function(asv_name) {
  bootstrap_k(OTU_table = OTU_table_df, n_boot = 1500, 
              asv_base = k_secuencias$filtered_values,
              asv_candidate = asv_name,
              alpha_weight = 0.5, beta_weight = 0.5, alpha = 0.05)
})

val_boot_05_05_df <- data.frame(val_boot_05_05)
```

```{r optimization with grid search}
set.seed(26)
# Define the complementary values of alpha and beta
alpha_vals <- seq(0, 1 , 0.1) 
results <- data.frame()

for (alpha in alpha_vals) {
  beta <- 1 - alpha
  cat("Runnning alpha =", alpha, "beta =", beta, "\n")
  
  k_fit <- k_validation(
    OTU_table = OTU_table_df,
    ground_truth = ground_truth_sequences,  # or ground_truth_species
    alpha = alpha,
    beta = beta,
    mode = "sequence" # or "taxonomy"
  )
  
  # Extract global metrics
  metrics <- k_fit$global_metrics
  filtered <- k_fit$filtered_values
  unfiltered <- k_fit$unfiltered_values
  
  results <- rbind(results, data.frame(
    alpha = alpha,
    beta = beta,
    Recovered_ASVs = length(k_fit$asvs_recuperadas),
    precision = metrics$precision,
    recall = metrics$recall,
    FDR = metrics$FDR,
    F1 = metrics$F1,
    k_inicial = filtered$k,
    k_max = k_fit$k_max,
    delta_k = k_fit$delta_k,
    time = as.numeric(k_fit$time)
  ))
}

# Display results sorted by F1 (highest to lowest)
results_grid2_search0.01_ <- results[order(-results$F1), ]
```

```{r optimization with grid search species}
set.seed(26)
# Define the complementary values of alpha and beta
alpha_vals <- seq(0, 1 , 0.1) 
results <- data.frame()

for (alpha in alpha_vals) {
  beta <- 1 - alpha
  cat("Runnning alpha =", alpha, "beta =", beta, "\n")
  
  k_fit <- k_validation(
    OTU_table = OTU_table_df,
    ground_truth = ground_truth_species,
    alpha = alpha,
    beta = beta,
    mode = "taxonomy" # or "taxonomy"
  )
  
  # Extract global metrics
  metrics <- k_fit$global_metrics
  filtered <- k_fit$filtered_values
  unfiltered <- k_fit$unfiltered_values
  
  results <- rbind(results, data.frame(
    alpha = alpha,
    beta = beta,
    Recovered_ASVs = length(k_fit$asvs_recuperadas),
    precision = metrics$precision,
    recall = metrics$recall,
    FDR = metrics$FDR,
    F1 = metrics$F1,
    k_inicial = filtered$k,
    k_max = k_fit$k_max,
    delta_k = k_fit$delta_k,
    time = as.numeric(k_fit$time)
  ))
}

# Display results sorted by F1 (highest to lowest)
results_grid_search_species <- results[order(-results$F1), ]
```

```{r bootstrap for best weights}
val_boot <- lapply(k_secuencias$asvs_recuperadas, function(asv_name) {
  bootstrap_k(OTU_table = OTU_table_df, 
              asv_base = k_secuencias$filtered_values,
              asv_candidate = asv_name,
              alpha = 0.05,
              alpha_weight = , beta_weight = ) # Indicate weights
})

val_boot_df <- data.frame(val_boot)
```

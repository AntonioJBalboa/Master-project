---
title: "k_optimization"
author: "Antonio Jes√∫s Balboa Ortega"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# load libraries
require(tidyverse)
require(vegan)
require(dplyr)
require(purrr)
require(tibble)
require(Biostrings)
require(pwalign)
require(BiocGenerics)
require(writexl)
# Seed
set.seed(26)
```

```{r}
set.seed(26)
# opcional para no correr de nuevo DADA2
ASV_table <- read.csv("ASV_table.csv")
rownames(ASV_table) <- ASV_table$X
ASV_table$X <- NULL

# Delete samples with low reads
depths <- rowSums(ASV_table)
summary(depths)
sort(depths)

# load modified species taxonomy for species
taxonomy_mod_100 <- read.csv("Taxonomia_100.csv")

# Create OTU table
sequences <- colnames(ASV_table)

asv_ids <- paste0("ASV", seq_along(sequences))

# Dictionary for storing sequences and taxa
seq_dict <- data.frame(
  ASV = asv_ids,
  Sequence =  sequences,
  taxa = taxonomy_mod_100$Genus_Species,
  Genus = taxonomy_mod_100$Genus,
  stringsAsFactors = FALSE)


colnames(ASV_table) <- asv_ids

OTU_table_filt <- ASV_table[depths>10000, ]

# Delete singletons
singleton_threshold <- 11 

asv_totals <- colSums(OTU_table_filt)
table(asv_totals < singleton_threshold)
n_singletons <- sum(asv_totals < singleton_threshold)

cat("ASVs con < ", singleton_threshold, " lecturas (a eliminar): ", n_singletons, "\n")

ASVs_to_keep <- names(asv_totals)[asv_totals >= singleton_threshold]
OTU_table_filt <- OTU_table_filt[, ASVs_to_keep, drop = FALSE]
```

```{r ground truth, include=FALSE}

# Defining ground truth

ground_truth_sequences <- data.frame(
  Bacteria = c("Bacillus licheniformis BT_1B_CT2","Bifidobacterium longum 12_1_47 B FAA","Rothia mucilaginosa ATCC 25296","Parvimonas micra ATCC 33270","Mogibacterium timidum ATCC 33093","Campylobacter concisus 10_1_50","Eggerthella lenta MR1 12","Slackia exigua ATCC 700122","klebsiella variicola 1_1_55","Fusobacterium periodonticum D10","Leptotrichia goodfellowii D28","Weisella cibaria kACC 11862","Eikenella corrodens CC82I","Neisseria pneumonie GT 4A CT1","Tannerella sp. 6_1_58 FAA CT1","Hoylesella oralis CC98A","Capnocytophaga sputigena ATCC 33612","Granulicatella adiacens ATCC 49175","Streptococcus gordonii 2_1_36 FAA","Gemella morbillorum M424","Dialister pneumosintes KCOM 1685","Veionella sp. 3_1_44","Coprobacillus cateniformis 29_1","Bifidobacterium angulatum JCM 7096","Collinsella aerofaciens 4_8_47 FAA","Bilophila wadsworthia 3_1_6","Escherichia coli 1_1_43","Fusobacterium gonidiaformans 3_1_5R","Fusobacterium ulcerans 12_1B","Anaerostipes hadrus ATCC 29173","Enterocloster bolteae 90A9","Lactobacillus iners 7_1_47 FAA","Pediococcus acidilactici 7_4A","Ralstonia pickettii 5_7_47 FAA","Paenibacillus barengoltzii G22","Parabacteroides merdae ATCC 43184","Bacteroides caccae CL03T12C61","Cutibacterium acnes NBRC 107605","Alistipes shahii WAL 8301","Subdoligranulum sp. 4_3_54A2FAA","Enterococcus saccharolyticus 30_1","Synergistes sp. 22_5_S_12_D6 FAA"),
  Sequence = c("ATACGTAGGTGGCAAGCGTTGTCCGGAATTATTGGGCGTAAAGCGCGCGCAGGCGGTTTCTTAAGTCTGATGTGAAAGCCCCCGGCTCAACCGGGGAGGGTCATTGGAAACTGGGGAACTTGAGTGCAGAAGAGGAGAGTGGAATTCCACGTGTAGCGGTGAAATGCGTAGAGATGTGGAGGAACACCAGTGGCGAAGGCGACTCTCTGGTCTGTAACTGACGCTGAGGCGCGAAAGCGTGGGGAGCGAACAGG",
               "TACGTAGGGTGCAAGCGTTATCCGGAATTATTGGGCGTAAAGGGCTCGTAGGCGGTTCGTCGCGTCCGGTGTGAAAGTCCATCGCTTAACGGTGGATCCGCGCCGGGTACGGGCGGGCTTGAGTGCGGTAGGGGAGACTGGAATTCCCGGTGTAACGGTGGAATGTGTAGATATCGGGAAGAACACCAATGGCGAAGGCAGGTCTCTGGGCCGTTACTGACGCTGAGGAGCGAAAGCGTGGGGAGCGAACAGGA",
               "TACGTAGGGCGCGAGCGTTGTCCGGAATTATTGGGCGTAAAGAGCTTGTAGGCGGTTTGTCGCGTCTGCTGTGAAAGGCCGGAGCTTAACTCCGTGTATTGCAGTGGGTACGGGCAGACTAGAGTGCAGTAGGGGAGACTGGAACTCCTGGTGTAGCGGTGGAATGCGCAGATATCAGGAAGAACACCGATGGCGAAGGCAGGTCTCTGGGCTGTAACTGACGCTGAGAAGCGAAAGCATGGGGAGCGAACAGG",
               "TACGTATGGGGCGAGCGTTGTCCGGAATTATTGGGCGTAAAGGGTACGTAGGCGGTTTTTTAAGTCAGGTGTGAAAGCGTGAGGCTTAACCTCATTAAGCACTTGAAACTGGAAGACTTGAGTGAAGGAGAGGAAAGTGGAATTCCTAGTGTAGCGGTGAAATGCGTAGATATTAGGAGGAATACCGGTGGCGAAGGCGACTTTCTGGACTTTTACTGACGCTCAGGTACGAAAGCGTGGGGAGCAAACAGGAT",
               "TACGTAGGGGGCAAGCGTTATCCGGAATTATTGGGCGTAAAGAGTGCGTAGGTGGTTACCTAAGCGCAAGGTTTAAATTAGAGGCTCAACCTCTACATGCCTTGCGAACTGGGCTACTTGAGTGCAGGAGGGGAAAGCGGAATTCCTAGTGTAGCGGTGAAATGCGTAGATATTAGGAGGAACACCGGCGGCGAAGGCGGCTTTCTGGACTGTAACTGACACTGAGGCACGAAAGCGTGGGTAGCAAACAGGAT",
               "TACGGAGGGTGCAAGCGTTACTCGGAATCACTGGGCGTAAAGGACGCGTAGGCGGATTATCAAGTCTCTTGTGAAATCCTATGGCTTAACCATAGAACTGCTTGGGAAACTGATAATCTAGAGTGAGGGAGAGGCAGATGGAATTGGTGGTGTAGGGGTAAAATCCGTAGAGATCACCAGGAATACCCATTGCGAAGGCGATCTGCTGGAACTCAACTGACGCTAATGCGTGAAAGCGTGGGGAGCAAACAGGA",
               "AATACGTAGGGAGCGAGCGTTATCCGGATTCATTGGGCGTAAAGAGCGCGTAGGCGGCCTCTCAAGCGGGATCTCTAATCCGAGGGCTCAACCCCCGGCCGGATCCCGAACTGGGAGGCTCGAGTTCGGTAGAGGCAGGCGGAATTCCCGGTGTAGCGGTGGAATGCGCAGATATCGGGAAGAACACCGATGGCGAAGGCAGCCTGCTGGGCCGCAACTGACGCTGAGGCGCGAAAGCTAGGGGAGCGAACAGG",
               "ATACGTAGGGGGCGAGCGTTATCCGGATTCATTGGGCGTAAAGCGCGCGCAGGCGGCCCGCCAAGCGGCCTCGTCGAAGCCGGGGGCTCAACCCCCGGAAGCGACCCGAACTGGCGGGCTCGAGTGGGGCAGGGGAGGATGGAATTCCCGGTGTAGCGGTGAAATGCGCAGATATCGGGAGGAACACCGACGGCGAAGGCAGCCCTCTGGGCCTTCACTGACGCTGAGGCGCGAAAGCTGGGGGAGCGAACAGG",
               "TACGGAGGGTGCAAGCGTTAATCGGAATTACTGGGCGTAAAGCGCACGCAGGCGGTCTGTCAAGTCGGATGTGAAATCCCCGGGCTCAACCTGGGAACTGCATTCGAAACTGGCAGGCTAGAGTCTTGTAGAGGGGGGTAGAATTCCAGGTGTAGCGGTGAAATGCGTAGAGATCTGGAGGAATACCGGTGGCGAAGGCGGCCCCCTGGACAAAGACTGACGCTCAGGTGCGAAAGCGTGGGGAGCAAACAGGA",
               "AATACGTATGTCACAAGCGTTATCCGGATTTATTGGGCGTAAAGCGCGTCTAGGTGGTTATGTAAGTCTGATGTGAAAATGCAGGGCTCAACTCTGTATTGCGTTGGAAACTGCATGACTAGAGTACTGGAGAGGTAAGCGGAACTACAAGTGTAGAGGTGAAATTCGTAGATATTTGTAGGAATGCCGATGGGGAAGCCAGCTTACTGGACAGATACTGACGCTAAAGCGCGAAAGCGTGGGTAGCAAACAGG",
               "TACGTATGTCGCGAGCGTTATCCGGAATTATTGGGCATAAAGGGCATCTAGGCGGACGATCAAGTCAGGGGTGAAAACTTGCGGCTCAACTGTAAGCTTGCCTTTGAAACTGATTGTCTAGAGTATTGGAAAGGTGGGCGGAACTACACGAGTAGAGGTGAAATTCGTAGATATGTGTAGGAATGCCGATGATGAAGATAGCTCACTGGACGATAACTGACGCTGAAGTGCGAAAGCTAGGGGAGCGAACAGGA",
               "TACGTATGTTCCAAGCGTTATCCGGATTTATTGGGCGTAAAGCGAGCGCAGACGGTTATTTAAGTCTGAAGTGAAAGCCCTCAGCTCAACTGAGGAATTGCTTTGGAAACTGGATGACTTGAGTGCAGTAGAGGAAAGTGGAACTCCATGTGTAGCGGTGAAATGCGTAGATATATGGAAGAACACCAGTGGCGAAGGCGGCTTTCTGGACTGTAACTGACGTTGAGGCTCGAAAGTGTGGGTAGCAAACAGGA",
               "TACGTAGGGTGCGAGCGTTAATCGGAATTACTGGGCGTAAAGCGAGCGCAGACGGTTATTTAAGCAGGATGTGAAATCCCCGGGCTTAACCTGGGAACTGCGTTCTGAACTGGATAGCTAGAGTGTGTCAGAGGGGGGTAGAATTCCACGTGTAGCAGTGAAATGCGTAGAGATGTGGAGGAATACCGATGGCGAAGGCAGCCCCCTGGGATAACACTGACGTTCATGCTCGAAAGCGTGGGTAGCAAACAGGA",
               "TACGTAGGGTGCGAGCGTTAATCGGAATTACTGGGCGTAAAGCGGGCGCAGACGGTTACTTAAGCAGGATGTGAAATCCCCGGGCTCAACCTGGGAACTGCGTTCTGAACTGGGTGACTAGAGTGTGTCAGAGGGAGGTAGAATTCCACGTGTAGCAGTGAAATGCGTAGAGATGTGGAGGAATACCGATGGCGAAGGCAGCCTCCTGGGATAACACTGACGTTCATGCCCGAAAGCGTGGGTAGCAAACAGGA",
               "CGCGGTAATACGGAAGATGCGAGCGGATTTATTGGGTTTAAAGGGTGCGTAGGCGGAAGGATAAGTCAGCGGTGAAATGCATTCAGCTCAACTGGAGAATTGCCGATGAAACTGTTTTTCTAGAGTATAAAAGAGGTATGCGGAATGCGTGGTGTAGCGGTGAAATGCATAGATATCACGCAGAACCCCGATTGCGAAGGCAGCATACTGGGCTATAACTGACGCTGAAGCACGAAAGCGTGGGTATCGAACAGG",
               "TACGGAAGGTCCGGGCGTTATCCGGATTTATTGGGTTTAAAGGGAGCGTAGGCAGTTTTTTAAGCGTGCTGTGAAATGTACCGGCTCAACCGGTGATGTGCAGCGCGAACTGGGAATCTTGAGTACGCAGTAAGCAGGCGGAATTCGTGGTGTAGCGGTGAAATGCTTAGATATCACGAAGAACTCCGATTGCGTAGGCAGCTTGCTGTAGCGTAACTGACGCTGAAGCTCGAAAGTGCGGGTATCGAACAGGA",
               "TACGGAGGATGCGAGCGTTATCCGGAATCATTGGGTTTAAAGGGTCCGTAGGCGGGCTGATAAGTCAGAGGTGAAAGCGCTTAGCTCAACTAAGCAACTGCCTTTGAAACTGTCAGTCTTGAATGATTGTGAAGTAGTTGGAATGTGTAGTGTAGCGGTGAAATGCTTAGATATTACACAGAACACCGATAGCGAAGGCATATTACTAACAATTTATTGACGCTGATGGACGAAAGCGTGGGGAGCGAACAGGA",
               "TACGTAGGTGGCAAGCGTTGTCCGGATTTATTGGGCGTAAAGCGAGCGCAGGCGGTTCCTTAAGTCTGATGTGAAAGCCCCCGGCTCAACCGGGGAGGGTCATTGGAAACTGGGGAACTTGAGTGCAGAAGAGGAGAGTGGAATTCCATGTGTAGCGGTGAAATGCGTAGATATATGGAGGAACACCAGTGGCGAAGGCGACTCTCTGGTCTGTAACTGACGCTGAGGCTCGAAAGCGTGGGTAGCAAACAGGA",
               "TACGTAGGTCCCGAGCGTTGTCCGGATTTATTGGGCGTAAAGCGAGCGCAGGCGGTTAGATAAGTCTGAAGTTAAAGGCTGTGGCTTAACCATAGTACGCTTTGGAAACTGTTTAACTTGAGTGCAGAAGGGGAGAGTGGAATTCCATGTGTAGCGGTGAAATGCGTAGATATATGGAGGAACACCGGTGGCGAAAGCGGCTCTCTGGTCTGTAACTGACGCTGAGGCTCGAAAGCGTGGGGAGCGAACAGGAT",
               "ATACGTAGGTGGCAAGCGTTGTCCGGAATTATTGGGCGTAAAGCGCGCGCAGGTGGTTTAATAAGTCTGATGTGAAAGCCCACGGCTCAACCGTGGAGGGTCATTGGAAACTGTTAAACTTGAGTGCAGGAGAGAAAAGTGGAATTCCTAGTGTAGCGGTGAAATGCGTAGAGATTAGGAGGAACACCAGTGGCGAAGGCGGCTTTTTGGCCTGTAACTGACACTGAGGCGCGAAAGCGTGGGGAGCAAACAGG",
               "TACGTAGGTGGCAAGCGTTGTCCGGAATTATTGGGCGTAAAGCGCGCGCAGGCGGCTTCTTAAGTCCATCTTAAAAGCGTGGGGCTCAACCCCATGAGGGGATGGAAACTGGGAAGCTGGAGTATCGGAGAGGAAAGTGGAATTCCTAGTGTAGCGGTGAAATGCGTAGAGATTAGGAAGAACACCGGTGGCGAAGGCGACTTTCTAGACGAAAACTGACGCTGAGGCGCGAAAGCGTGGGGAGCAAACAGGAT",
               "TACGTAGGTGGCAAGCGTTGTCCGGAATTATTGGGCGTAAAGCGCGCGCAGGCGGATAGGTCAGTCTGTCTTAAAAGTTCGGGGCTTAACCCCGTGATGGGATGGAAACTGCCAATCTAGAGTATCGGAGAGGAAAGTGGAATTCCTAGTGTAGCGGTGAAATGCGTAGATATTAGGAAGAACACCAGTGGCGAAGGCGACTTTCTGGACGAAAACTGACGCTGAGGCGCGAAAGCCAGGGGAGCGAACGGGAT",
               "TACGTAGGTGGCGAGCGTTATCCGGAATCATTGGGCGTAAAGAGGGAGCAGGCGGCAATAGAGGTCTGCGGTGAAAGCCTGAAGCTAAACTTCAGTAAGCCGTGGAAACCAAATAGCTAGAGTGCAGTAGAGGATCGTGGAATTCCATGTGTAGCGGTGAAATGCGTAGATATATGGAGGAACACCAGTGGCGAAGGCGACGATCTGGGCTGCAACTGACGCTCAGTCCCGAAAGCGTGGGGAGCAAATAGGAT",
               "TACGTAGGGTGCAAGCGTTATCCGGAATTATTGGGCGTAAAGAGCTCGTAGGCGGTTCGTCGCGTCCGGTGTGAAAGTCCATCGCTTAACGGTGGATCTGCGCCGGGTACGGGCGGGCTGGAGTGCGGTAGGGGAGACTGGAATTCCCGGTGTAACGGTGGAATGTGTAGATATCGGGAAGAACACCAATGGCGAAGGCAGGTCTCTGGGCCGTTACTGACGCTGAGGAGCGAAAGCGTGGGGAGCGAACAGGA",
               "TACGTAGGGGGCGAGCGTTATCCGGATTCATTGGGCGTAAAGCGCGCGTAGGCGGCCCGGCAGGCCGGGGGTCGAAGCGGGGGGCTCAACCCCCCGAAGCCCCCGGAACCTCCGCGGCTTGGGTCCGGTAGGGGAGGGTGGAACACCCGGTGTAGCGGTGGAATGCGCAGATATCGGGTGGAACACCGGTGGCGAAGGCGGCCCTCTGGGCCGAGACCGACGCTGAGGCGCGAAAGCTGGGGGAGCGAACAGGA",
               "TACGGAGGGTGCAAGCGTTAATCGGAATCACTGGGCGTAAAGCGCACGTAGGCGGCTTGGTAAGTCAGGGGTGAAATCCCACAGCCCAACTGTGGAACTGCCTTTGATACTGCCAGGCTTGAGTACCGGAGAGGGTGGCGGAATTCCAGGTGTAGGAGTGAAATCCGTAGATATCTGGAGGAACACCGGTGGCGAAGGCGGCCACCTGGACGGTAACTGACGCTGAGGTGCGAAAGCGTGGGTAGCAAACAGGA",
               "ATACGGAGGGTGCAAGCGTTAATCGGAATTACTGGGCGTAAAGCGCACGCAGGCGGTTTGTTAAGTCAGATGTGAAATCCCCGGGCTCAACCTGGGAACTGCATCTGATACTGGCAAGCTTGAGTCTCGTAGAGGGGGGTAGAATTCCAGGTGTAGCGGTGAAATGCGTAGAGATCTGGAGGAATACCGGTGGCGAAGGCGGCCCCCTGGACGAAGACTGACGCTCAGGTGCGAAAGCGTGGGGAGCAAACAGG",
               "AATACGTATGTCGCAAGCGTTATCCGGATTTATTGGGCGTAAAGCGCGTCTAGGCGGCAAGGAAAGTCTGATGTGAAAATGCGGGGCTCAACTCCGTATTGCGTTGGAAACTGCCTTACTAGAGTACTGGAGAGGTAGGCGGAACTACAAGTGTAGAGGTGAAATTCGTAGATATTTGTAGGAATGCCGATGGGGAAGCCAGCTACTGGACAGATACTGACGCTAAAGCGCGAAAGCGTGGGTAGCAAACAGG",
               "TACGTATGTCGCAAGCGTTATCCGGATTTATTGGGCGTAAAGCGCGTCTAGGCGGCAAGGAAAGTCTGATGTGAAAATGCGGGGCTCAACTCCGTATTGCGTTGGAAACTGCCTTACTAGAGTACTGGAGAGGTAGGCGGAACTACAAGTGTAGAGGTGAAATTCGTAGATATTTGTAGGAATGCCGATGGGGAAGCCAGCCTACTGGACAGATACTGACGCTAAAGCGCGAAAGCGTGGGTAGCAAACAGGAT",
               "TACGTAGGGGGCAAGCGTTATCCGGAATTACTGGGTGTAAAGGGTGCGTAGGTGGTATGGCAAGTCAGAAGTGAAAACCCAGGGCTTAACTCTGGGACTGCTTTTGAAACTGTCAGACTGGAGTGCAGGAGAGGTAAGCGGAATTCCTAGTGTAGCGGTGAAATGCGTAGATATTAGGAGGAACATCAGTGGCGAAGGCGGCTTACTGGACTGAAACTGACACTGAGGCACGAAAGCGTGGGGAGCAAACAGGA",
               "TACGTAGGGGGCAAGCGTTATCCGGATTTACTGGGTGTAAAGGGAGCGTAGACGGCGAAGCAAGTCTGAAGTGAAAACCCAGGGCTCAACCCTGGGACTGCTTTGGAAACTGTTTTGCTAGAGTGTCGGAGAGGTAAGTGGAATTCCTAGTGTAGCGGTGAAATGCGTAGATATTAGGAGGAACACCAGTGGCGAAGGCGGCTTACTGGACGATAACTGACGTTGAGGCTCGAAAGCGTGGGGAGCAAACGCAG",
               "ACGTAGGTGGCAAGCGTTGTCCGGATTTATTGGGCGTAAAGCGAGTGCAGGCGGCTCGATAAGTCTGATGTGAAAGCCTTCGGCTCAACCGGAGAATTGCATCAGAAACTGTCGAGCTTGAGTACAGAAGAGGAGAGTGGAACTCCATGTGTAGCGGTGAAATGCGTAGATATATGGAAGAACACCGGTGGCGAAGGCGGCTCTCTGGTCTGTTACTGACGCTGAGGCTCGAAAGCATGGGTAGCGAACAGGAT",
               "ACGTAGGTGGCAAGCGTTATCCGGATTTATTGGGCGTAAAGCGAGCGCAGGCGGTCTTTTAAGTCTAATGTGAAAGCCTTCGGCTCAACCGAAGAAGTGCATTGGAAACTGGGAGACTTGAGTGCAGAAGAGGACAGTGGAACTCCATGTGTAGCGGTGAAATGCGTAGATATATGGAAGAACACCAGTGGCGAAGGCGGCTGTCTGGTCTGTAACTGACGCTGAGGCTCGAAAGCATGGGTAGCGAACAGGAT",
               "TACGTAGGGTCCAAGCGTTAATCGGAATTACTGGGCGTAAAGCGTGCGCAGGCGGTTGTGCAAGACCGATGTGAAATCCCCGAGCTTAACTTGGGAATTGCATTGGTGACTGCACGGCTAGAGTGTGTCAGAGGGGGGTAGAATTCCACGTGTAGCAGTGAAATGCGTAGAGATGTGGAGGAATACCGATGGCGAAGGCAGCCCCCTGGGATAACACTGACGCTCATGCACGAAAGCGTGGGGAGCAAACAGGA",
               "TACGTAGGGGGCGAGCGTTGTCCGGAATTATTGGGCGTAAAGCGCGCGCAGGCGGCTGTTTAAGTCTGGTGTTTAATCCTGGGGCTCAACCCCGGGTCGCACTGGAAACTGGGCAGCTTGAGTGCAGAAGAGGAGAGTGGAATTCCACGTGTAGCGGTGAAATGCGTAGAGATGTGGAGGAACACCAGTGGCGAAGGCGACTCTCTGGGCTGTAACTGACGCTGAGGCGCGAAAGCGTGGGGAGCAAACAGGAT",
               "TACGGAGGATGCGAGCGTTATCCGGATTTATTGGGTTTAAAGGGTGCGTAGGTGGTGATTTAAGTCAGCGGTGAAAGTTTGTGGCTCAACCATAAAATTGCCGTTGAAACTGGGTTACTTGAGTGTGTTTGAGGTAGGCGGAATGCGTGGTGTAGCGGTGAAATGCATAGATATCACGCAGAACTCCGATTGCGAAGGCAGCTTACTAAACCATAACTGACACTGAAGCACGAAAGCGTGGGGATCAAACAGGA",
               "TACGGAGGATCCGAGCGTTATCCGGATTTATTGGGTTTAAAGGGAGCGTAGGCGGATTGTTAAGTCAGTTGTGAAAGTTTGCGGCTCAACCGTAAAATTGCAGTTGATACTGGCAGTCTTGAGTGCAGTAGAGGTGGGCGGAATTCGTGGTGTAGCGGTGAAATGCTTAGATATCACGAAGAACTCCGATTGCGAAGGCAGCTCACTGGAGTGTAACTGACGCTGATGCTCGAAAGTGTGGGTATCAAACAGGA",
               "TACGTAGGGTGCGAGCGTTGTCCGGATTTATTGGGCGTAAAGGGCTCGTAGGTGGTTGATCGCGTCGGAAGTGTAATCTTGGGGCTTAACCCTGAGCGTGCTTTCGATACGGGTTGACTTGAGGAAGGTAGGGGAGAATGGAATTCCTGGTGGAGCGGTGGAATGCGCAGATATCAGGAGGAACACCAGTGGCGAAGGCGGTTCTCTGGGCCTTTCCTGACGCTGAGGAGCGAAAGCGTGGGGAGCGAACAGGC",
               "TACGGAGGATCCAAGCGTTATCCGGATTTATTGGGTTTAAAGGGTGCGTAGGCGGTTTGATAAGTTAGAGGTGAAATACCGGTGCTTAACACCGGAACTGCCTCTAATACTGTTGAACTAGAGAGTAGTTGCGGTAGGCGGAATGTATGGTGTAGCGGTGAAATGCTTAGAGATCATACAGAACACCGATTGCGAAGGCAGCTTACCAAACTATATCTGACGTTGAGGCACGAAAGCGTGGGGAGCAAACAGGA",
               "AACGTAGGGTGCAAGCGTTGTCCGGAATTACTGGGTGTAAAGGGAGCGCAGGCGGATTGGCAAGTTGGGAGTGAAATCTATGGGCTCAACCCATAAATTGCTTTCAAAACTGTCAGTCTTGAGTGGTGTAGAGGTAGGCGGAATTCCCGGTGTAGCGGTGGAATGCGTAGATATCGGGAGGAACACCAGTGGCGAAGGCGGCCTACTGGGCACTAACTGACGCTGAGGCTCGAAAGCATGGGTAGCAAACCTCA",
               "ACGTAGGTGGCAAGCGTTGTCCGGATTTATTGGGCGTAAAGCGAGCGCAGGCGGTTTCTTAAGTCTGATGTGAAAGCCCCCGGCTCAACCGGGGAGGGTCATTGGAAACTGGGAGACTTGAGTGCAGAAGAGGAGAGTGGAATTCCATGTGTAGCGGTGAAATGCGTAGATATATGGAGGAACACCAGTGGCGAAGGCGGCTCTCTGGTCTGTAACTGACGCTGAGGCTCGAAAGCGTGGGGAGCGAACAGGAT",
               "TACGTAGGGGGCGAGCGTTGTTCGGAATTACTGGGCGTAAAGCGCACGCAGGCGGACCAGTAAGTCTGTCGTCAAAGGCGGAGGCTCAACCTTCGTTCCACGATAGATACTGCGGGTCTAGAGTATGTGAGAGGGAAGTGGAATTCCCGGTGTAGCGGTGAAATGCGTAGATATCGGGAGGAACACCAGTGGCGAAGGCGGCTTCCTGGCACACAACTGACGCTCATGTGCGAAAGCCAGGGCAGCGAACGGGA"))


ground_truth_taxa <- list(species = c("Bacillus_licheniformis","Bifidobacterium_longum","Rothia_mucilaginosa","Parvimonas_micra","Mogibacterium_timidum","Campylobacter_concisus","Eggerthella_lenta","Slackia_exigua","klebsiella_variicola","Fusobacterium_periodonticum","Leptotrichia_goodfellowii","Weisella_cibaria","Eikenella_corrodens","Neisseria_mucosa","Tannerella_sp","Prevotella_oralis","Capnocytophaga_sputigena","Granulicatella_adiacens","Streptococcus_gordonii","Gemella_morbillorum","Dialister_pneumosintes","Veionella_parvula","Coprobacillus_cateniformis","Bifidobacterium_angulatum","Collinsella_aerofaciens","Bilophila_wadsworthia","Escherichia_coli","Fusobacterium_gonidiaformans","Fusobacterium_varium","Fusobacterium_ulcerans","Anaerostipes_hadrus","Enterocloster_bolteae","Lactobacillus_iners","Pediococcus_acidilactici","Ralstonia_pickettii","Paenibacillus_barengoltzii","Parabacteroides_merdae","Bacteroides_caccae","Cutibacterium_acnes","Alistipes_shahii","Subdoligranulum_variabile","Enterococcus_saccharolyticus","Synergistes_sp."), genus = c("Bacillus","Bifidobacterium","Rothia","Parvimonas","Mogibacterium","Campylobacter","Eggerthella","Slackia","klebsiella","Fusobacterium","Leptotrichia","Weisella","Eikenella","Neisseria","Tannerella","Prevotella","Hoylesella","Capnocytophaga","Granulicatella","Streptococcus","Gemella","Dialister","Veionella","Coprobacillus","Collinsella","Bilophila","Escherichia","Escherichia/Shigella","Fusobacterium","Anaerostipes","Clostridium","Lactobacillus","Pediococcus","Ralstonia","Paenibacillus","Parabacteroides","Bacteroides","Propionibacterium","Cutibacterium","Alistipes","Subdoligranulum","Enterococcus","Synergistes"))

OTU_table_filt_df <- data.frame(OTU_table_filt)
```

```{r k optimization}
set.seed(26)
# List of differents Filters configurations   
filter_configs <- list(
  
  # Standard configuration
  "1" = list(
    col_max = 10, 
    pct_samples_threshold = 0.05, 
    abundance_threshold = 0.00005, 
    prevalence = 2
  ),
  
  "2" = list(
    col_max = 10, 
    pct_samples_threshold = 0.05, 
    abundance_threshold = 0.00007, 
    prevalence = 2
  ),
  
  "3" = list(
    col_max = 10, 
    pct_samples_threshold = 0.05, 
    abundance_threshold = 0.00009, 
    prevalence = 2
  ),
  
  "4" = list(
    col_max = 10, 
    pct_samples_threshold = 0.05, 
    abundance_threshold = 0.0001, 
    prevalence = 2
  ),
  
  "5" = list(
    col_max = 10, 
    pct_samples_threshold = 0.05, 
    abundance_threshold = 0.0002, 
    prevalence = 2
  ),
  
  "6" = list(
    col_max = 10, 
    pct_samples_threshold = 0.05, 
    abundance_threshold = 0.0003, 
    prevalence = 2
  ),
  
  "7" = list(
    col_max = 10, 
    pct_samples_threshold = 0.05, 
    abundance_threshold = 0.00035, 
    prevalence = 2
  ),

  "8" = list(
    col_max = 10, 
    pct_samples_threshold = 0.05, 
    abundance_threshold = 0.00042, 
    prevalence = 2
  ),
  
  "9" = list(
    col_max = 10, 
    pct_samples_threshold = 0.05, 
    abundance_threshold = 0.00045, 
    prevalence = 2
  ),
  
  "10" = list(
    col_max = 10, 
    pct_samples_threshold = 0.05, 
    abundance_threshold = 0.0005, 
    prevalence = 2
  )
)

ground_truths_list <- list(
  "taxonomy" = ground_truth_taxa, 
  "sequence" = ground_truth_sequences
)

# Weights
alphas <- seq(0, 1, by = 0.1)
weight_grid <- data.frame(alpha = alphas, beta = 1 - alphas)

all_plots_list_k2 <- list() # To save all graphs
results_df_k2 <- data.frame() # To save data

# Iterate over the filters
for (filt_name in names(filter_configs)) {
  
  current_params <- filter_configs[[filt_name]]
  
  for (mode_name in names(ground_truths_list)) {
    
    current_gt <- ground_truths_list[[mode_name]]
    
    message(paste("Processing:", filt_name, "| Mode:", mode_name))
  
    # Grid search
    for (i in 1:nrow(weight_grid)) {
      
      a <- weight_grid$alpha[i]
      b <- weight_grid$beta[i]
      
      k_optimization <- k2_optimization(
        OTU_table = OTU_table_filt_df,
        ground_truth = current_gt,
        alpha = a,
        beta = b,
        mode = mode_name,
        filter_parameters = current_params
      )
      
      # Save results
      plot_id <- paste(filt_name, mode_name, a, b, sep = "_")
      
      all_plots_list_k2[[plot_id]] <- plot_k2(k_optimization)
      
      df <- k_optimization$df_results
      
      df$Filter_Config <- filt_name
      df$Mode <- mode_name
      df$Alpha <- a
      df$Beta <- b
      
      # Unir al dataframe principal
      results_df_k2 <- rbind(results_df_k2, df)
    }
  }
}

# Save plots as a RDS file
saveRDS(all_plots_list_k2, "all_plot_list_k2.rds")
```

```{r}
# Plots k2
# Filter 1
print(all_plots_list_k2$`1_taxonomy_0.5_0.5`)
print(all_plots_list_k2$`1_taxonomy_0.6_0.4`)
print(all_plots_list_k2$`1_taxonomy_0.7_0.3`)
print(all_plots_list_k2$`1_taxonomy_0.8_0.2`)
print(all_plots_list_k2$`1_taxonomy_0.9_0.1`)
print(all_plots_list_k2$`1_taxonomy_1_0`)
print(all_plots_list_k2$`1_taxonomy_0.4_0.6`)
print(all_plots_list_k2$`1_taxonomy_0.3_0.7`)
print(all_plots_list_k2$`1_taxonomy_0.2_0.8`)
print(all_plots_list_k2$`1_taxonomy_0.1_0.9`)
print(all_plots_list_k2$`1_taxonomy_0_1`)
print(all_plots_list_k2$`1_sequence_0.5_0.5`)
print(all_plots_list_k2$`1_sequence_0.6_0.4`)
print(all_plots_list_k2$`1_sequence_0.7_0.3`)
print(all_plots_list_k2$`1_sequence_0.8_0.2`)
print(all_plots_list_k2$`1_sequence_0.9_0.1`)
print(all_plots_list_k2$`1_sequence_1_0`)
print(all_plots_list_k2$`1_sequence_0.4_0.6`)
print(all_plots_list_k2$`1_sequence_0.3_0.7`)
print(all_plots_list_k2$`1_sequence_0.2_0.8`)
print(all_plots_list_k2$`1_sequence_0.1_0.9`)
print(all_plots_list_k2$`1_sequence_0_1`)
```

```{r}
# Plots k2
# Filter 2
print(all_plots_list_k2$`2_taxonomy_0.5_0.5`)
print(all_plots_list_k2$`2_taxonomy_0.6_0.4`)
print(all_plots_list_k2$`2_taxonomy_0.7_0.3`)
print(all_plots_list_k2$`2_taxonomy_0.8_0.2`)
print(all_plots_list_k2$`2_taxonomy_0.9_0.1`)
print(all_plots_list_k2$`2_taxonomy_1_0`)
print(all_plots_list_k2$`2_taxonomy_0.4_0.6`)
print(all_plots_list_k2$`2_taxonomy_0.3_0.7`)
print(all_plots_list_k2$`2_taxonomy_0.2_0.8`)
print(all_plots_list_k2$`2_taxonomy_0.1_0.9`)
print(all_plots_list_k2$`2_taxonomy_0_1`)
```

```{r}
# Plots k2
# Filter 3
print(all_plots_list_k2$`3_taxonomy_0.5_0.5`)
print(all_plots_list_k2$`3_taxonomy_0.6_0.4`)
print(all_plots_list_k2$`3_taxonomy_0.7_0.3`)
print(all_plots_list_k2$`3_taxonomy_0.8_0.2`)
print(all_plots_list_k2$`3_taxonomy_0.9_0.1`)
print(all_plots_list_k2$`3_taxonomy_1_0`)
print(all_plots_list_k2$`3_taxonomy_0.4_0.6`)
print(all_plots_list_k2$`3_taxonomy_0.3_0.7`)
print(all_plots_list_k2$`3_taxonomy_0.2_0.8`)
print(all_plots_list_k2$`3_taxonomy_0.1_0.9`)
print(all_plots_list_k2$`3_taxonomy_0_1`)
```

```{r}
# Plots k2
# Filter 4
print(all_plots_list_k2$`4_taxonomy_0.5_0.5`)
print(all_plots_list_k2$`4_taxonomy_0.6_0.4`)
print(all_plots_list_k2$`4_taxonomy_0.7_0.3`)
print(all_plots_list_k2$`4_taxonomy_0.8_0.2`)
print(all_plots_list_k2$`4_taxonomy_0.9_0.1`)
print(all_plots_list_k2$`4_taxonomy_1_0`)
print(all_plots_list_k2$`4_taxonomy_0.4_0.6`)
print(all_plots_list_k2$`4_taxonomy_0.3_0.7`)
print(all_plots_list_k2$`4_taxonomy_0.2_0.8`)
print(all_plots_list_k2$`4_taxonomy_0.1_0.9`)
print(all_plots_list_k2$`4_taxonomy_0_1`)
```


```{r}
# Plots k2
# Filter 5
print(all_plots_list_k2$`5_taxonomy_0.5_0.5`)
print(all_plots_list_k2$`5_taxonomy_0.6_0.4`)
print(all_plots_list_k2$`5_taxonomy_0.7_0.3`)
print(all_plots_list_k2$`5_taxonomy_0.8_0.2`)
print(all_plots_list_k2$`5_taxonomy_0.9_0.1`)
print(all_plots_list_k2$`5_taxonomy_1_0`)
print(all_plots_list_k2$`5_taxonomy_0.4_0.6`)
print(all_plots_list_k2$`5_taxonomy_0.3_0.7`)
print(all_plots_list_k2$`5_taxonomy_0.2_0.8`)
print(all_plots_list_k2$`5_taxonomy_0.1_0.9`)
print(all_plots_list_k2$`5_taxonomy_0_1`)
```

```{r}
# Plots k2
# Filter 6
print(all_plots_list_k2$`6_taxonomy_0.5_0.5`)
print(all_plots_list_k2$`6_taxonomy_0.6_0.4`)
print(all_plots_list_k2$`6_taxonomy_0.7_0.3`)
print(all_plots_list_k2$`6_taxonomy_0.8_0.2`)
print(all_plots_list_k2$`6_taxonomy_0.9_0.1`)
print(all_plots_list_k2$`6_taxonomy_1_0`)
print(all_plots_list_k2$`6_taxonomy_0.4_0.6`)
print(all_plots_list_k2$`6_taxonomy_0.3_0.7`)
print(all_plots_list_k2$`6_taxonomy_0.2_0.8`)
print(all_plots_list_k2$`6_taxonomy_0.1_0.9`)
print(all_plots_list_k2$`6_taxonomy_0_1`)
```

```{r}
# Plots k2
# Filter 7
print(all_plots_list_k2$`7_taxonomy_0.5_0.5`)
print(all_plots_list_k2$`7_taxonomy_0.6_0.4`)
print(all_plots_list_k2$`7_taxonomy_0.7_0.3`)
print(all_plots_list_k2$`7_taxonomy_0.8_0.2`)
print(all_plots_list_k2$`7_taxonomy_0.9_0.1`)
print(all_plots_list_k2$`7_taxonomy_1_0`)
print(all_plots_list_k2$`7_taxonomy_0.4_0.6`)
print(all_plots_list_k2$`7_taxonomy_0.3_0.7`)
print(all_plots_list_k2$`7_taxonomy_0.2_0.8`)
print(all_plots_list_k2$`7_taxonomy_0.1_0.9`)
print(all_plots_list_k2$`7_taxonomy_0_1`)
```

```{r}
# Plots k2
# Filter 8
print(all_plots_list_k2$`8_taxonomy_0.5_0.5`)
print(all_plots_list_k2$`8_taxonomy_0.6_0.4`)
print(all_plots_list_k2$`8_taxonomy_0.7_0.3`)
print(all_plots_list_k2$`8_taxonomy_0.8_0.2`)
print(all_plots_list_k2$`8_taxonomy_0.9_0.1`)
print(all_plots_list_k2$`8_taxonomy_1_0`)
print(all_plots_list_k2$`8_taxonomy_0.4_0.6`)
print(all_plots_list_k2$`8_taxonomy_0.3_0.7`)
print(all_plots_list_k2$`8_taxonomy_0.2_0.8`)
print(all_plots_list_k2$`8_taxonomy_0.1_0.9`)
print(all_plots_list_k2$`8_taxonomy_0_1`)
```

```{r}
# Plots k2
# Filter 9
print(all_plots_list_k2$`9_taxonomy_0.5_0.5`)
print(all_plots_list_k2$`9_taxonomy_0.6_0.4`)
print(all_plots_list_k2$`9_taxonomy_0.7_0.3`)
print(all_plots_list_k2$`9_taxonomy_0.8_0.2`)
print(all_plots_list_k2$`9_taxonomy_0.9_0.1`)
print(all_plots_list_k2$`9_taxonomy_1_0`)
print(all_plots_list_k2$`9_taxonomy_0.4_0.6`)
print(all_plots_list_k2$`9_taxonomy_0.3_0.7`)
print(all_plots_list_k2$`9_taxonomy_0.2_0.8`)
print(all_plots_list_k2$`9_taxonomy_0.1_0.9`)
print(all_plots_list_k2$`9_taxonomy_0_1`)
```

```{r}
# Plots k2
# Filter 10
print(all_plots_list_k2$`10_taxonomy_0.5_0.5`)
print(all_plots_list_k2$`10_taxonomy_0.6_0.4`)
print(all_plots_list_k2$`10_taxonomy_0.7_0.3`)
print(all_plots_list_k2$`10_taxonomy_0.8_0.2`)
print(all_plots_list_k2$`10_taxonomy_0.9_0.1`)
print(all_plots_list_k2$`10_taxonomy_1_0`)
print(all_plots_list_k2$`10_taxonomy_0.4_0.6`)
print(all_plots_list_k2$`10_taxonomy_0.3_0.7`)
print(all_plots_list_k2$`10_taxonomy_0.2_0.8`)
print(all_plots_list_k2$`10_taxonomy_0.1_0.9`)
print(all_plots_list_k2$`10_taxonomy_0_1`)
```


```{r}
library(writexl)
data_analysis <- results_df_k2 %>%
  filter(
    Filter_Config == "1",   
    Alpha == 0,             
    Beta == 1,            
    Mode == "taxonomy"      
  )

# K_initial
k_initial <- data_analysis$k_values[1] - data_analysis$delta_k[1]

# Prepare for function
function_input <- list(
  df_results = data_analysis,
  k_initial = k_initial
)


tabla_metricas_final <- calculate_threshold_metrics(function_input)

View(tabla_metricas_final)

write_xlsx(tabla_metricas_final,"k2_metrics.xlsx")
```


```{r global normalization con chao1}

all_plots_list_k3 <- list() # To save all graphs
results_df_k3 <- data.frame() # To save data
    # Grid search
    for (i in 1:nrow(weight_grid)) {
      
      a <- weight_grid$alpha[i]
      b <- weight_grid$beta[i]
      
      k_optimization <- k3_optimization(
        OTU_table = OTU_table_filt_df,
        ground_truth = ground_truth_taxa,
        alpha = a,
        beta = b,
        mode = "taxonomy",
        filter_parameters = filter_configs[["1"]]
      )
      
      # Save results
      plot_id <- paste("1", "taxonomy", a, b, sep = "_")
      
      all_plots_list_k3[[plot_id]] <- plot_k3(k_optimization)
      
      df <- k_optimization$df_results
      
      df$Filter_Config <- "1"
      df$Mode <- "taxonomy"
      df$Alpha <- a
      df$Beta <- b
      
      # Unir al dataframe principal
      results_df_k3 <- rbind(results_df_k3, df)
    }

# Save plots as a RDS file
saveRDS(all_plots_list_k3, "all_plot_list_k3.rds")
```

```{r}
# Plots k3
# Filter 1
print(all_plots_list_k3$`1_taxonomy_0.5_0.5`)
print(all_plots_list_k3$`1_taxonomy_0.6_0.4`)
print(all_plots_list_k3$`1_taxonomy_0.7_0.3`)
print(all_plots_list_k3$`1_taxonomy_0.8_0.2`)
print(all_plots_list_k3$`1_taxonomy_0.9_0.1`)
print(all_plots_list_k3$`1_taxonomy_1_0`)
print(all_plots_list_k3$`1_taxonomy_0.4_0.6`)
print(all_plots_list_k3$`1_taxonomy_0.3_0.7`)
print(all_plots_list_k3$`1_taxonomy_0.2_0.8`)
print(all_plots_list_k3$`1_taxonomy_0.1_0.9`)
print(all_plots_list_k3$`1_taxonomy_0_1`)
```

```{r approach with jaccard}
all_plots_list_k4 <- list() # To save all graphs
results_k4_df <- data.frame() # To save data

for (filt_name in names(filter_configs)) {
  
  current_params <- filter_configs[[filt_name]]
  
  for (mode_name in names(ground_truths_list)) {
    
    current_gt <- ground_truths_list[[mode_name]]
    
    message(paste("Processing:", filt_name, "| Mode:", mode_name))
  
    # Grid search
    for (i in 1:nrow(weight_grid)) {
      
      a <- weight_grid$alpha[i]
      b <- weight_grid$beta[i]
      
      k_optimization <- k4_optimization(
        OTU_table = OTU_table_filt_df,
        ground_truth = current_gt,
        alpha = a,
        beta = b,
        mode = mode_name,
        filter_parameters = current_params
      )
      
      # Save results
      plot_id <- paste(filt_name, mode_name, a, b, sep = "_")
      
      all_plots_list_k4[[plot_id]] <- plot_k4(k_optimization)
      
      df <- k_optimization$df_results
      
      df$Filter_Config <- filt_name
      df$Mode <- mode_name
      df$Alpha <- a
      df$Beta <- b
      
      # Unir al dataframe principal
      results_k4_df <- rbind(results_k4_df, df)
    }
  }
}
# Save plots as a RDS file
saveRDS(all_plots_list_k4, "all_plot_list_k4.rds")
```

```{r}
# Plots k4
# Filter 1
print(all_plots_list_k4$`1_taxonomy_0.5_0.5`)
print(all_plots_list_k4$`1_taxonomy_0.6_0.4`)
print(all_plots_list_k4$`1_taxonomy_0.7_0.3`)
print(all_plots_list_k4$`1_taxonomy_0.8_0.2`)
print(all_plots_list_k4$`1_taxonomy_0.9_0.1`)
print(all_plots_list_k4$`1_taxonomy_1_0`)
print(all_plots_list_k4$`1_taxonomy_0.4_0.6`)
print(all_plots_list_k4$`1_taxonomy_0.3_0.7`)
print(all_plots_list_k4$`1_taxonomy_0.2_0.8`)
print(all_plots_list_k4$`1_taxonomy_0.1_0.9`)
print(all_plots_list_k4$`1_taxonomy_0_1`)
```

```{r}
# Plots k4
# Filter 2
print(all_plots_list_k4$`2_taxonomy_0.5_0.5`)
print(all_plots_list_k4$`2_taxonomy_0.6_0.4`)
print(all_plots_list_k4$`2_taxonomy_0.7_0.3`)
print(all_plots_list_k4$`2_taxonomy_0.8_0.2`)
print(all_plots_list_k4$`2_taxonomy_0.9_0.1`)
print(all_plots_list_k4$`2_taxonomy_1_0`)
print(all_plots_list_k4$`2_taxonomy_0.4_0.6`)
print(all_plots_list_k4$`2_taxonomy_0.3_0.7`)
print(all_plots_list_k4$`2_taxonomy_0.2_0.8`)
print(all_plots_list_k4$`2_taxonomy_0.1_0.9`)
print(all_plots_list_k4$`2_taxonomy_0_1`)
```

```{r}
# Plots k4
# Filter 3
print(all_plots_list_k4$`3_taxonomy_0.5_0.5`)
print(all_plots_list_k4$`3_taxonomy_0.6_0.4`)
print(all_plots_list_k4$`3_taxonomy_0.7_0.3`)
print(all_plots_list_k4$`3_taxonomy_0.8_0.2`)
print(all_plots_list_k4$`3_taxonomy_0.9_0.1`)
print(all_plots_list_k4$`3_taxonomy_1_0`)
print(all_plots_list_k4$`3_taxonomy_0.4_0.6`)
print(all_plots_list_k4$`3_taxonomy_0.3_0.7`)
print(all_plots_list_k4$`3_taxonomy_0.2_0.8`)
print(all_plots_list_k4$`3_taxonomy_0.1_0.9`)
print(all_plots_list_k4$`3_taxonomy_0_1`)
```

```{r}
# Plots k4
# Filter 4
print(all_plots_list_k4$`4_taxonomy_0.5_0.5`)
print(all_plots_list_k4$`4_taxonomy_0.6_0.4`)
print(all_plots_list_k4$`4_taxonomy_0.7_0.3`)
print(all_plots_list_k4$`4_taxonomy_0.8_0.2`)
print(all_plots_list_k4$`4_taxonomy_0.9_0.1`)
print(all_plots_list_k4$`4_taxonomy_1_0`)
print(all_plots_list_k4$`4_taxonomy_0.4_0.6`)
print(all_plots_list_k4$`4_taxonomy_0.3_0.7`)
print(all_plots_list_k4$`4_taxonomy_0.2_0.8`)
print(all_plots_list_k4$`4_taxonomy_0.1_0.9`)
print(all_plots_list_k4$`4_taxonomy_0_1`)
```


```{r}
# Plots k4
# Filter 5
print(all_plots_list_k4$`5_taxonomy_0.5_0.5`)
print(all_plots_list_k4$`5_taxonomy_0.6_0.4`)
print(all_plots_list_k4$`5_taxonomy_0.7_0.3`)
print(all_plots_list_k4$`5_taxonomy_0.8_0.2`)
print(all_plots_list_k4$`5_taxonomy_0.9_0.1`)
print(all_plots_list_k4$`5_taxonomy_1_0`)
print(all_plots_list_k4$`5_taxonomy_0.4_0.6`)
print(all_plots_list_k4$`5_taxonomy_0.3_0.7`)
print(all_plots_list_k4$`5_taxonomy_0.2_0.8`)
print(all_plots_list_k4$`5_taxonomy_0.1_0.9`)
print(all_plots_list_k4$`5_taxonomy_0_1`)
```

```{r}
# Plots k4
# Filter 6
print(all_plots_list_k4$`6_taxonomy_0.5_0.5`)
print(all_plots_list_k4$`6_taxonomy_0.6_0.4`)
print(all_plots_list_k4$`6_taxonomy_0.7_0.3`)
print(all_plots_list_k4$`6_taxonomy_0.8_0.2`)
print(all_plots_list_k4$`6_taxonomy_0.9_0.1`)
print(all_plots_list_k4$`6_taxonomy_1_0`)
print(all_plots_list_k4$`6_taxonomy_0.4_0.6`)
print(all_plots_list_k4$`6_taxonomy_0.3_0.7`)
print(all_plots_list_k4$`6_taxonomy_0.2_0.8`)
print(all_plots_list_k4$`6_taxonomy_0.1_0.9`)
print(all_plots_list_k4$`6_taxonomy_0_1`)
```

```{r}
# Plots k4
# Filter 7
print(all_plots_list_k4$`7_taxonomy_0.5_0.5`)
print(all_plots_list_k4$`7_taxonomy_0.6_0.4`)
print(all_plots_list_k4$`7_taxonomy_0.7_0.3`)
print(all_plots_list_k4$`7_taxonomy_0.8_0.2`)
print(all_plots_list_k4$`7_taxonomy_0.9_0.1`)
print(all_plots_list_k4$`7_taxonomy_1_0`)
print(all_plots_list_k4$`7_taxonomy_0.4_0.6`)
print(all_plots_list_k4$`7_taxonomy_0.3_0.7`)
print(all_plots_list_k4$`7_taxonomy_0.2_0.8`)
print(all_plots_list_k4$`7_taxonomy_0.1_0.9`)
print(all_plots_list_k4$`7_taxonomy_0_1`)
```

```{r}
# Plots k4
# Filter 8
print(all_plots_list_k4$`8_taxonomy_0.5_0.5`)
print(all_plots_list_k4$`8_taxonomy_0.6_0.4`)
print(all_plots_list_k4$`8_taxonomy_0.7_0.3`)
print(all_plots_list_k4$`8_taxonomy_0.8_0.2`)
print(all_plots_list_k4$`8_taxonomy_0.9_0.1`)
print(all_plots_list_k4$`8_taxonomy_1_0`)
print(all_plots_list_k4$`8_taxonomy_0.4_0.6`)
print(all_plots_list_k4$`8_taxonomy_0.3_0.7`)
print(all_plots_list_k4$`8_taxonomy_0.2_0.8`)
print(all_plots_list_k4$`8_taxonomy_0.1_0.9`)
print(all_plots_list_k4$`8_taxonomy_0_1`)
```

```{r}
# Plots k4
# Filter 9
print(all_plots_list_k4$`9_taxonomy_0.5_0.5`)
print(all_plots_list_k4$`9_taxonomy_0.6_0.4`)
print(all_plots_list_k4$`9_taxonomy_0.7_0.3`)
print(all_plots_list_k4$`9_taxonomy_0.8_0.2`)
print(all_plots_list_k4$`9_taxonomy_0.9_0.1`)
print(all_plots_list_k4$`9_taxonomy_1_0`)
print(all_plots_list_k4$`9_taxonomy_0.4_0.6`)
print(all_plots_list_k4$`9_taxonomy_0.3_0.7`)
print(all_plots_list_k4$`9_taxonomy_0.2_0.8`)
print(all_plots_list_k4$`9_taxonomy_0.1_0.9`)
print(all_plots_list_k4$`9_taxonomy_0_1`)
```

```{r}
# Plots k4
# Filter 10
print(all_plots_list_k4$`10_taxonomy_0.5_0.5`)
print(all_plots_list_k4$`10_taxonomy_0.6_0.4`)
print(all_plots_list_k4$`10_taxonomy_0.7_0.3`)
print(all_plots_list_k4$`10_taxonomy_0.8_0.2`)
print(all_plots_list_k4$`10_taxonomy_0.9_0.1`)
print(all_plots_list_k4$`10_taxonomy_1_0`)
print(all_plots_list_k4$`10_taxonomy_0.4_0.6`)
print(all_plots_list_k4$`10_taxonomy_0.3_0.7`)
print(all_plots_list_k4$`10_taxonomy_0.2_0.8`)
print(all_plots_list_k4$`10_taxonomy_0.1_0.9`)
print(all_plots_list_k4$`10_taxonomy_0_1`)
```


```{r}
# metrics for k4 in alpha=0.7 and beta = 0.3
data_analysis <- results_k4_df %>%
  filter(
    Filter_Config == "1",   
    near(Alpha, 0.7),             
    near(Beta, 0.3),            
    Mode == "taxonomy"      
  )

# K_initial
k_initial <- data_analysis$k_values[1] - data_analysis$delta_k[1]

# Prepare for function
function_input <- list(
  df_results = data_analysis,
  k_initial = k_initial
)


tabla_metricas_final_k4 <- calculate_threshold_metrics(function_input)

View(tabla_metricas_final_k4)

write_xlsx(tabla_metricas_final_k4,"k4_metrics.xlsx")
```


```{r}
#Chao1 - Jaccard
all_plots_list_k5 <- list() # To save all graphs
results_df_k5 <- data.frame() # To save data
    # Grid search
    for (i in 1:nrow(weight_grid)) {
      
      a <- weight_grid$alpha[i]
      b <- weight_grid$beta[i]
      
      k_optimization <- k5_optimization(
        OTU_table = OTU_table_filt_df,
        ground_truth = ground_truth_taxa,
        alpha = a,
        beta = b,
        mode = "taxonomy",
        filter_parameters = filter_configs[["1"]]
      )
      
      # Save results
      plot_id <- paste("1", "taxonomy", a, b, sep = "_")
      
      all_plots_list_k5[[plot_id]] <- plot_k5(k_optimization)
      
      df <- k_optimization$df_results
      
      df$Filter_Config <- "1"
      df$Mode <- "taxonomy"
      df$Alpha <- a
      df$Beta <- b
      
      # Unir al dataframe principal
      results_df_k5 <- rbind(results_df_k5, df)
    }

# Save plots as a RDS file
saveRDS(all_plots_list_k5, "all_plot_list_k5.rds")
```

```{r}
# plots k5
print(all_plots_list_k5$`1_taxonomy_0.5_0.5`)
print(all_plots_list_k5$`1_taxonomy_0.6_0.4`)
print(all_plots_list_k5$`1_taxonomy_0.7_0.3`)
print(all_plots_list_k5$`1_taxonomy_0.8_0.2`)
print(all_plots_list_k5$`1_taxonomy_0.9_0.1`)
print(all_plots_list_k5$`1_taxonomy_0.4_0.6`)
print(all_plots_list_k5$`1_taxonomy_0.3_0.7`)
print(all_plots_list_k5$`1_taxonomy_0.2_0.8`)
print(all_plots_list_k5$`1_taxonomy_0.1_0.9`)
print(all_plots_list_k5$`1_taxonomy_0_1`)
```

```{r}
# Pielou - Aitchison
all_plots_list_k6 <- list() # To save all graphs
results_df_k6 <- data.frame() # To save data
    # Grid search
    for (i in 1:nrow(weight_grid)) {
      
      a <- weight_grid$alpha[i]
      b <- weight_grid$beta[i]
      
      k_optimization <- k6_optimization(
        OTU_table = OTU_table_filt_df,
        ground_truth = ground_truth_taxa,
        alpha = a,
        beta = b,
        mode = "taxonomy",
        filter_parameters = filter_configs[["1"]]
      )
      
      # Save results
      plot_id <- paste("1", "taxonomy", a, b, sep = "_")
      
      all_plots_list_k6[[plot_id]] <- plot_k6(k_optimization)
      
      df <- k_optimization$df_results
      
      df$Filter_Config <- "1"
      df$Mode <- "taxonomy"
      df$Alpha <- a
      df$Beta <- b
      
      # Unir al dataframe principal
      results_df_k6 <- rbind(results_df_k6, df)
    }

# Save plots as a RDS file
saveRDS(all_plots_list_k6, "all_plot_list_k6.rds")
```

```{r}
# plots k6
print(all_plots_list_k6$`1_taxonomy_0.5_0.5`)
print(all_plots_list_k6$`1_taxonomy_0.6_0.4`)
print(all_plots_list_k6$`1_taxonomy_0.7_0.3`)
print(all_plots_list_k6$`1_taxonomy_0.8_0.2`)
print(all_plots_list_k6$`1_taxonomy_0.9_0.1`)
print(all_plots_list_k6$`1_taxonomy_1_0`)
print(all_plots_list_k6$`1_taxonomy_0.4_0.6`)
print(all_plots_list_k6$`1_taxonomy_0.3_0.7`)
print(all_plots_list_k6$`1_taxonomy_0.2_0.8`)
print(all_plots_list_k6$`1_taxonomy_0.1_0.9`)
print(all_plots_list_k6$`1_taxonomy_0_1`)
```


```{r}

data_analysis <- results_df_k3 %>%
  filter(
    Filter_Config == "1",   
    Alpha == 0.5,             
    Beta == 0.5,            
    Mode == "taxonomy"      
  )

# K_initial
k_initial <- data_analysis$k_values[1] - data_analysis$delta_k[1]

# Prepare for function
function_input <- list(
  df_results = data_analysis,
  k_initial = k_initial
)


tabla_metricas_final <- calculate_threshold_metrics(function_input)

View(tabla_metricas_final)

write_xlsx(tabla_metricas_final,"k3_metrics.xlsx")
```

```{r}

data_analysis <- results_df_k5 %>%
  filter(
    Filter_Config == "1",   
    Alpha == 0.5,             
    Beta == 0.5,            
    Mode == "taxonomy"      
  )

# K_initial
k_initial <- data_analysis$k_values[1] - data_analysis$delta_k[1]

# Prepare for function
function_input <- list(
  df_results = data_analysis,
  k_initial = k_initial
)


tabla_metricas_final <- calculate_threshold_metrics(function_input)

View(tabla_metricas_final)

write_xlsx(tabla_metricas_final,"k5_metrics.xlsx")
```

```{r}
data_analysis <- results_df_k6 %>%
  filter(
    Filter_Config == "1",   
    Alpha == 0,             
    Beta == 1,            
    Mode == "taxonomy"      
  )

# K_initial
k_initial <- data_analysis$k_values[1] - data_analysis$delta_k[1]

# Prepare for function
function_input <- list(
  df_results = data_analysis,
  k_initial = k_initial
)


tabla_metricas_final <- calculate_threshold_metrics(function_input)

View(tabla_metricas_final)

write_xlsx(tabla_metricas_final,"k6_metrics.xlsx")
```




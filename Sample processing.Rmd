---
title: "Sample processing"
author: "Antonio Jesús Balboa Ortega"

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r config, include=FALSE}
require(BiocManager)
require(dada2)
require(tidyverse)
require(vegan)
require(dplyr)
require(purrr)
require(ggupset)
require(tibble)

# Seed
set.seed(26)
```

```{r}
# Cargamos las lecturas
r1 <- sort(list.files("A:/DOCUMENTOS/Máster Bioinformática y Bioestadística/TFM/Master project/muestras", pattern = "_1.fastq", full.names = TRUE))
r2 <- sort(list.files("A:/DOCUMENTOS/Máster Bioinformática y Bioestadística/TFM/Master project/muestras", pattern = "_2.fastq", full.names = TRUE))

# PlotQualityProfile O FASTQC
#plotQualityProfile(r1)
#plotQualityProfile(r2)

# extract names from the samples
samples_names <- sapply(strsplit(basename(r1), "_1.fastq"), `[`, 1)


# Define names
if (!dir.exists("filtered_fastq")) {
  dir.create("filtered_fastq")
}

# create output folders for filtered sequencess
filt_forwards <- file.path("filtered_fastq", paste0(samples_names, "_F_filt.fastq"))
filt_reverse <- file.path("filtered_fastq", paste0(samples_names, "_R_filt.fastq"))

names(filt_forwards) <- samples_names
names(filt_reverse) <- samples_names

# cut to 230 for forward and 200 for reverse
out <- filterAndTrim(r1, filt_forwards, r2, filt_reverse,
                     truncLen=c(230, 200),
                     maxN=0, 
                     maxEE=c(2, 2), 
                     truncQ=2, 
                     rm.phix=TRUE,
                     compress=FALSE, 
                     multithread=TRUE)

errF<- learnErrors(filt_forwards, multithread=TRUE)
errR <- learnErrors(filt_reverse, multithread=TRUE)

# Plot errors
plotErrors(errF, nominalQ=TRUE)
plotErrors(errR, nominalQ = TRUE)

dadaFs <- dada(filt_forwards, err=errF, multithread=TRUE)
dadaRs <- dada(filt_reverse, err=errR, multithread=TRUE)

mergers <- mergePairs(dadaFs, filt_forwards, dadaRs, filt_reverse, verbose=TRUE)

seqtab <- makeSequenceTable(mergers)

seqtab.nochim <- removeBimeraDenovo(seqtab, method="consensus", multithread=TRUE, verbose=TRUE)

taxa <- assignTaxonomy(seqtab.nochim2, "silva_nr_v132_train_set.fa.gz", multithread=TRUE)
taxa <- addSpecies(taxa, "silva_species_assignment_v132.fa")

# Save as CSV
write.csv(seqtab.nochim2, "ASV_table.csv")
```






